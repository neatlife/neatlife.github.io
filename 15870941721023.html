<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  mysql查询优化相关技术 - xiaolin's blog
  
  </title>
  
  
  <link href="atom.xml" rel="alternate" title="xiaolin's blog" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />
    <link rel="shortcut icon" href="favicon.ico">
    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
  function before_search(){
    var searchVal = 'site:neatlifecoco.com ' + document.getElementById('search_input').value;
    document.getElementById('search_q').value = searchVal;
    return true;
  }
</script>
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>


  <section class="top-bar-section">
  <div class="row">
      <div style="position: relative;width:100%;"><div style="position: absolute; width:100%;">
        <ul id="main-menu" class="left">
        
        <li id=""><a target="_self" href="index.html">about</a></li>
        
        <li id=""><a target="_self" href="all.html">blog</a></li>
        
        <li id=""><a target="_self" href="archives.html">archive</a></li>
        
        <li id=""><a target="_self" href="tools.html">tools</a></li>
        
        <li id=""><a target="_self" href="pro.html">pros</a></li>
        
        <li id=""><a target="_self" href="pub.html">press</a></li>
        
        <li id=""><a target="_self" href="paper.html">paper</a></li>
        
        </ul>

        <ul class="right" id="search-wrap">
          <li>
<form target="_blank" onsubmit="return before_search();" action="https://google.com/search" method="get">
    <input type="hidden" id="search_q" name="q" value="" />
    <input tabindex="1" type="search" id="search_input"  placeholder="Search"/>
</form>
</li>
          </ul>
      </div></div>
  </div>
  </section>

</nav>

        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; xiaolin's blog</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
        
        <li><a target="_self" href="index.html">about</a></li>
        
        <li><a target="_self" href="all.html">blog</a></li>
        
        <li><a target="_self" href="archives.html">archive</a></li>
        
        <li><a target="_self" href="tools.html">tools</a></li>
        
        <li><a target="_self" href="pro.html">pros</a></li>
        
        <li><a target="_self" href="pub.html">press</a></li>
        
        <li><a target="_self" href="paper.html">paper</a></li>
        

    <li><label>Categories</label></li>

        
            <li><a href="macios.html">mac&ios</a></li>
        
            <li><a href="lc.html">leetcode</a></li>
        
            <li><a href="security.html">安全</a></li>
        
            <li><a href="business.html">业务</a></li>
        
            <li><a href="source-code.html">源码分析</a></li>
        
            <li><a href="redis.html">Redis</a></li>
        
            <li><a href="apache-nginx.html">Apache/Nginx</a></li>
        
            <li><a href="spring-boot.html">Spring Boot</a></li>
        
            <li><a href="pm.html">项目管理</a></li>
        
            <li><a href="sql.html">SQL</a></li>
        
            <li><a href="job-scheduler.html">任务调度</a></li>
        
            <li><a href="design-pattern.html">设计模式</a></li>
        
            <li><a href="mq.html">消息队列</a></li>
        
            <li><a href="rpc.html">RPC</a></li>
        
            <li><a href="laravel.html">LARAVEL</a></li>
        
            <li><a href="tcp-ip.html">TCP/IP</a></li>
        
            <li><a href="uml.html">UML</a></li>
        
            <li><a href="service-mesh.html">SERVICE MESH</a></li>
        
            <li><a href="ci-cd.html">CI/CD</a></li>
        
            <li><a href="ops.html">OPS</a></li>
        
            <li><a href="linux.html">LINUX</a></li>
        
            <li><a href="system-programming.html">系统编程</a></li>
        
            <li><a href="aws.html">AWS</a></li>
        
            <li><a href="lua.html">LUA</a></li>
        
            <li><a href="git.html">GIT</a></li>
        
            <li><a href="js.html">js</a></li>
        
            <li><a href="java.html">JAVA</a></li>
        
            <li><a href="monitor.html">监控</a></li>
        
            <li><a href="vim.html">VIM</a></li>
        
            <li><a href="php.html">PHP</a></li>
        
            <li><a href="openresty.html">OpenResty</a></li>
        
            <li><a href="swoole.html">SWOOLE</a></li>
        
            <li><a href="ons.html">消息队列</a></li>
        
            <li><a href="gdb.html">GDB</a></li>
        
            <li><a href="specification.html">规范</a></li>
        
            <li><a href="3-minutes.html">三分钟系列</a></li>
        
            <li><a href="1-pic.html">一图胜千言</a></li>
        
            <li><a href="account-system.html">帐号系统</a></li>
        
            <li><a href="interview.html">面试题</a></li>
        
            <li><a href="yii.html">Yii/Yii2</a></li>
        
            <li><a href="python.html">python</a></li>
        
            <li><a href="go.html">GO</a></li>
        
            <li><a href="ml.html">机器学习</a></li>
        
            <li><a href="emacs.html">emacs</a></li>
        
            <li><a href="bi.html">商业智能</a></li>
        
            <li><a href="mac.html">mac</a></li>
        
            <li><a href="editor.html">编辑器</a></li>
        
            <li><a href="productive-soft.html">生产力工具</a></li>
        
            <li><a href="driver-license.html">驾照</a></li>
         

      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>


        <section id="main-content" role="main" class="scroll-container">
        
       

 <script type="text/javascript">
  $(function(){
    $('#menu_item_index').addClass('is_active');
  });
</script>
<div class="row">
  <div class="large-8 medium-8 columns">
      <div class="markdown-body article-wrap">
       <div class="article">
          
          <h1>mysql查询优化相关技术</h1>
     
        <div class="read-more clearfix">
          <span class="date">2020/4/17</span>

          <span>posted in&nbsp;</span> 
          
              <span class="posted-in"><a href='specification.html'>规范</a></span>
          
              <span class="posted-in"><a href='sql.html'>SQL</a></span>
           
         
          <span class="comments">
            

            
          </span>

        </div>
      </div><!-- article -->

      <div class="article-content">
      <ol>
<li>查询优化
<ol>
<li>SQL查询执行顺序</li>
<li>Where条件相关性能问题</li>
<li>子查询(in/exist)相关</li>
<li>分组排序相关</li>
</ol></li>
<li>索引优化</li>
<li>事务</li>
</ol>

<h2 id="toc_0">0x01 SQL查询执行顺序</h2>

<table>
<thead>
<tr>
<th>执行顺序</th>
<th>SQL关键字</th>
<th>执行内容</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>8</td>
<td>SELECT</td>
<td>根据选择的字段,结果写入虚拟表T8</td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>DISTINCT 字段</td>
<td>对SELECT的结果T8执行去重后, 写入虚拟表T9</td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>FROM 左表 as a</td>
<td>对FROM中的左表与右表执行笛卡尔积,生成虚拟表T1</td>
<td>每步操作结果都会生成一个虚拟表, 这里用T加执行顺序号来命名</td>
</tr>
<tr>
<td>3</td>
<td>LEFT JOIN 右表 as b</td>
<td>如指定了左外连接,会将左表中存在,但右表不存在的行,添加到T2表,生成虚拟表T3; 如果FROM中包含多个表, 则会将T3与下一表重复执行步骤1~3</td>
<td>Join类型:  Inner: 内联接, 等值连接  Outer: 外连接, 常用的Left join(以左表记录为基准),   Right join(以右表记录为基准)</td>
</tr>
<tr>
<td>2</td>
<td>ON a.id = b.id</td>
<td>对T1表应用on条件筛选, 符合条件的行写入虚拟表T2</td>
<td>Inner jojn中on 与where条件效果相同;   left join中on与where条件效果不同;</td>
</tr>
<tr>
<td>4</td>
<td>WHERE 条件</td>
<td>对T3表应用where条件过滤, 符合条件的记录写入T4表</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>GROUP BY 字段</td>
<td>根据group by中字段 , 对T4执行分组,生成虚拟表T5</td>
<td>注意:不在GROUP BY中的字段,如果出现在SELECT中,都要使用聚合类函数,不推荐下面的写法:  Select a,b, sum(c) from t  Group by a</td>
</tr>
<tr>
<td>6</td>
<td>WITH ROLLUP [CUBE]</td>
<td>对T5结果,按不同维度执行统计,生成虚拟表T6</td>
<td>GROUP BY ROLLUP(A,B,C) 结果  (A,B,C),(A,B), (A)  GROUP BY CUBE(A,B,C)结果  (A,B,C),(A,B)(A,C),(B,C)(A),(B),(C)</td>
</tr>
<tr>
<td>7</td>
<td>HAVING 条件</td>
<td>对T6结果执行过滤,结果写入虚拟表T7</td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>ORDER BY 字段</td>
<td>对DISTINCT后的结果T9, 执行排序后写入虚拟表T10</td>
<td>这部分可以使用字段别名, 字段运算或按字段顺序号执行排序操作</td>
</tr>
<tr>
<td>11</td>
<td>LIMIT</td>
<td>对T10取出指定行数据记录后,返回最终结果</td>
<td></td>
</tr>
</tbody>
</table>

<span id="more"></span><!-- more -->

<h2 id="toc_1">0x02 数据类型隐式转换</h2>

<p>如果where条件中的字段是varchar, 查询时传入的是int或int,varchar混用方式,  即使字段上有索引 ，仍然会执行全表扫描(特别要注意大表的查询或更新); <br/>
简单取巧的方式： 如果字段上有索引 ，但不确认字段是int或varchar,  可以全按字段串方式传入 ，这样不会有性能问题</p>

<pre><code class="language-sql">SELECT
    *
FROM
    tb_example
WHERE
    uid IN ( 17467432, 1617938, &#39;15698321&#39; );
</code></pre>

<p>正确写法：</p>

<pre><code class="language-sql">SELECT
*
FROM
    tb_example
WHERE
    uid IN ( &#39;17467432&#39;, &#39;1617938&#39;, &#39;15698321&#39; );
</code></pre>

<p>注意:  当字段类型为int时, 传入数字, 加不加引号都能正常使用索引; 但是, 当传入字符数据时, 由于找不到对应的数值, 系统会将其转化为0来处理, 遇到表中0值较多时, 会出现全表扫描问题</p>

<pre><code class="language-sql">SELECT
    *
FROM
    tb_example
WHERE
    device_id = &#39;unknown&#39;
ORDER BY
    `id` DESC
</code></pre>

<p>等价于: </p>

<pre><code class="language-sql">SELECT
    *
FROM
    `tb_example`
WHERE
    device_id = 0
ORDER BY
    `id` DESC
</code></pre>

<h2 id="toc_2">0x03 字段做函数类运算</h2>

<p>由于语句对字段use_date做了日期转换，导致复合索引(xxx_status ,use_date)只能用到xxx_status , 无法利用use_date进行过滤</p>

<pre><code class="language-sql">SELECT
    COUNT( 1 ) AS cnt
FROM
    tb_xxx
WHERE
    xxx_status = 2 AND  DATE_FORMAT( use_date, &#39;%Y%m%d&#39; ) = DATE_FORMAT( &#39;2019-06-01&#39;, &#39;%Y%m%d&#39; )
</code></pre>

<p>正确写法：<br/>
取消对字段的函数转换， 将日期转为对应的时间段， 修改后查询用时在13毫秒(修改前用时在1.2秒+)</p>

<pre><code class="language-sql">SELECT
    COUNT( 1 ) AS cnt
FROM
    tb_xxx
WHERE
    xxx_status = 2 AND    ( use_date &gt;= &#39;2019-06-01&#39; AND use_date &lt; &#39;2019-06-02&#39; )
</code></pre>

<h2 id="toc_3">0x04 字符集不同引发性能异常</h2>

<p>tb_example 两表join时，会提示错误：Illegal mix of collations (utf8mb4_general_ci,IMPLICIT) AND (utf8mb4_unicode_ci,IMPLICIT) FOR operation &#39;=&#39;, 所以开发同事添加了convert保持字符集一致， 但这样会导致全表数据的字符集转换问题</p>

<pre><code class="language-sql">SELECT  i.example_column
FROM
    tb_example i
    LEFT JOIN tb_example a ON  i.example_column =  CONVERT ( a.example_column USING utf8mb4 )
WHERE
    i.create_time BETWEEN &#39;2019-05-27 00:00:00&#39; 
    AND &#39;2019-05-27 23:59:59&#39; 
    AND l.create_time &lt; i.create_time AND a.create_time &gt; i.create_time ORDER BY  i.example_column DESC
</code></pre>

<h3 id="toc_4">优化方式:</h3>

<p>(1)统一字符集比较规则<br/>
tb_example 表的数据比较规则修改为utf8mb4_general_ci（utf8mb4_general_ci性能要高于utf8mb4_unicode_ci)</p>

<pre><code class="language-sql">ALTER TABLE tb_example CONVERT TO CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
</code></pre>

<p>(2)表间关联字段添加索引</p>

<pre><code class="language-sql">ALTER TABLE tb_example ADD INDEX (create_time);
ALTER TABLE tb_example ADD INDEX (example_column);
</code></pre>

<h3 id="toc_5">正确写法: </h3>

<pre><code class="language-sql">SELECT  i.example_column  
FROM
    tb_example i
    LEFT JOIN tb_example a ON  i.example_column =   a.example_column 
WHERE
    i.create_time BETWEEN &#39;2019-05-27 00:00:00&#39;
    AND &#39;2019-05-27 23:59:59&#39; a.create_time &gt; i.create_time ORDER BY  i.example_column DESC
</code></pre>

<h2 id="toc_6">0x05 字符集补充说明</h2>

<p>字符集按库-&gt;表-&gt;字段 ，从上到下的顺序继承， 即建库时指定了utf8mb4, 表与字段未指定字符集时，会继承库的字符集ut8mb4;<br/>
反过来则是覆盖关系 ，如果指定库字符集为utf8mb4, 多人同时开发时, 如果建表时有指定utf8, 那么表使用utf8字符集，如果在修改字段时指定为gbk,则此字段实际存储数据时按gbk存储，<br/>
这种情况会导致乱码产生或多表join时的性能问题，需要特别注意</p>

<h2 id="toc_7">0x06 or与union all</h2>

<p>建议将or条件转换为union all，充分利用多个or条件上的索引以提高性能</p>

<pre><code class="language-sql">select count(id) as num_count from tb_example where uid = 8212123 and (type = 1 or type  = 2 or type = 3) and read_yn = 0
</code></pre>

<p>正确写法:</p>

<pre><code class="language-sql">SELECT SUM(id) FROM (
SELECT COUNT(id) AS id FROM tb_example WHERE uid=8212123 AND read_yn=0 AND TYPE=1 UNION ALL
SELECT COUNT(id) FROM tb_example WHERE uid=8212123 AND read_yn=0 AND NAME=2 UNION ALL
SELECT COUNT(id) FROM tb_example WHERE uid=8212123 AND read_yn=0 AND TYPE=3) t
</code></pre>

<p>注意:<br/>
Union对结果集执行去重操作,而Union all不去重复, 所以后者性能较高,可以根据业务需要选择使用</p>

<h2 id="toc_8">0x07 NULL与DEFAULT使用</h2>

<p>(1)建议表字段定义为NOT NULL, 尽量设置默认值(如int默认为0, varchar默认为’’，date默认为1000-01-01等), 将读写时的True, False, NULL三值判断变为True,False两值判断,方便代码中处理<br/>
注意: NOT NULL 与 DEFAULT要同时设置才能取消NULL值写入</p>

<p>例: 字段允许NULL时, 查询所有数据</p>

<pre><code class="language-sql">select … from ... where username = &#39;a&#39; or username != &#39;a&#39; or username is null
</code></pre>

<p>字段NOT NULL时,查询所有数据</p>

<pre><code class="language-sql">select … from ... where username = &#39;a&#39; or username != &#39;a&#39;
</code></pre>

<p>  (2)select/update语句的where条件中使用 is null 判断null, 不能使用 =null,  update中更新字段部分可以使用 set 字段= null</p>

<pre><code class="language-sql">Update … set name = null where name is null ?
Select … from … where name is null ?
</code></pre>

<h2 id="toc_9">0x08 LEFT JOIN中ON与WHERE差异</h2>

<p>(1)LEFT JOIN中ON不起过滤作用, 实际执行时会将两表join时的相等记录与<br/>
左表中存在但右表不存在的记录组合在一起</p>

<pre><code class="language-sql">SELECT a.uid AS a_uid, b.uid AS b_uid  FROM tb_example a
LEFT JOIN tb_example b ON a.uid = b.uid
AND a.uid = 12547784
</code></pre>

<p><img src="media/15870941721023/15870961823359.jpg" alt=""/></p>

<p>(2)LEFT JOIN中WHERE才起到真正的过滤作用<br/>
   INNER JOIN:内联接, 可简写为JOIN, 无论使用ON还是WHERE结果都一样</p>

<pre><code class="language-sql">SELECT a.uid AS a_uid, b.uid AS b_uid  FROMtb_example a
LEFT JOIN tb_example b ON a.uid = b.uid
WHERE a.uid = 12547784
</code></pre>

<p><img src="media/15870941721023/15870962258071.jpg" alt=""/></p>

<h2 id="toc_10">0x09 in子查询列表值数量</h2>

<p>当in子查询列表值数量&gt;=1000时(不同版本会有差异), mysql会使用到临时表不降低性能,    注意控制传值数量, </p>

<pre><code class="language-sql">SELECT * FROM tb_order_detailed
WHERE child_oid IN(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18…)
</code></pre>

<h2 id="toc_11">0x0A not exists 与 not in</h2>

<p>(1)当外部表A数据量明显大于子查询内部表B时使用in</p>

<pre><code class="language-sql">SELECT A.name FROM A 
WHERE NAME in(SELECT NAME FROM B)
</code></pre>

<p>(2)当外部表A数据量明显小于子查询内部表B时, 使用exists</p>

<pre><code class="language-sql">SELECT A.name FROM A 
WHERE EXISTS(SELECT NAME FROM B WHERE B.id = A.id)
</code></pre>

<p>当使用not in时注意,如果子查询的结果中包含null时,  实际返回结果为空, not exits没有这问题<br/>
例:  当业务上确认以下查询有结果返回时,  如果B表中name有一行null记录存在时,  实际会出现没记录返回的情况</p>

<pre><code class="language-sql">SELECT * FROM A WHERE name NOT IN (SELECT NAME FROM B)   # 无结果
SELECT * FROM A WHERE name NOT EXISTS(SELECT NAME FROM B WHERE A.id = B.id)   # 正常返回结果
</code></pre>

<h2 id="toc_12">0x0B order by...limit分页</h2>

<p>MySQL中的order by ...limit通常适用于查首页，最后页，数据量大时查中间页性能非常差 查前10条用时 0.001s SELECT * FROM tb_example ORDER BY id LIMIT 0,10 查10万条开始的前10条:　0.07s SELECT * FROM tb_example ORDER BY id LIMIT 100000,10</p>

<p>常见优化方式：<br/>
(1)借助主键<br/>
如果是批量拉取数据, 可以先通过条件获取对应的主键 , 通过主键字段关联来取中间页数据;前端页面上的分页优化方法较多, 主要原则也是避开随机查询中间页数据</p>

<pre><code class="language-sql"> SELECT a.* FROM tb_example a, (SELECT id FROM tb_example ORDER BY id LIMIT 10000,10) b WHERE a.id = b.id
</code></pre>

<p>(2) 使用分析函数生成序号 CTE<br/>
注意:  数量过千万的大表, 排序时会比较慢, 要限制并发执行次数</p>

<pre><code class="language-sql">WITH tmp AS (
    SELECT
        ROW_NUMBER ( ) OVER ( ORDER BY post_id ) AS rn,
        post_id
    FROM
        tb_post
    WHERE
        create_date &lt;= &#39;2019-08-15 00:00:00&#39;
        AND post_type = 5
    ) SELECT
    a.post_id,
    a.cover_img
FROM
    tb_example a,
    tmp b
WHERE
    b.rn &gt;= 6000
    AND b.rn &lt; 8000
    AND a.post_id = b.post_id;
</code></pre>

<h2 id="toc_13">0x0C 排序索引选择</h2>

<p>mysql是基于成本选择的执行计划, 以下语句中create_date字段有索引, 但执行计划认为排序成本较高, 所以会优先选择order by 中的id主键索引, 导致实际用时在10s以上</p>

<pre><code class="language-sql">SELECT * FROM `tb_example `t` WHERE (create_date &gt;= &#39;2020-02-25 00:00:00&#39;)) AND create_date &lt;= &#39;2020-02-25 23:59:59&#39;) AND (STATUS = 1) ORDER BY id DESC LIMIT 100
</code></pre>

<p>优化写法:<br/>
通常情况日期随着自增id增长不断顺序写入, 可以将order by中的id更换为create_date , 充分利用时间索引, 可将耗时下降到10ms+<br/>
如果日期字段与自增id不是这种关系或业务上验证两者返回结果有差异时, 不能使用此方法</p>

<pre><code class="language-sql">SELECT
    *
FROM
    `tb_example `t`
WHERE
    ( create_date &gt;= &#39;2020-02-25 00:00:00&#39; AND create_date &lt;= &#39;2020-02-25 23:59:59&#39; )
    AND ( STATUS = 1 )  
ORDER BY
    create_date  DESC
    LIMIT 100
</code></pre>

<h2 id="toc_14">0x0D group by用法及误区</h2>

<p>以下group by写法是msyql扩展语法, 新版本中默认启用full group by限制, 执行会报语法错误, 由于咱们这边早期没做这方面限制, 现在限制会影响很多业务,  强制不推荐使用</p>

<pre><code class="language-sql">SELECT
    relate_order_id,
    COUNT( * ),
    create_date,
    SUM( price_deposit ) 
FROM
    `tb_example WHERE create_date &gt;&#39;2020-02-01&#39; GROUP BY relate_order_id
</code></pre>

<p>正确写法:<br/>
不在GROUP BY中的字段 , 在SELECT中都要使用聚合类函数, 如SUM,MAX,COUNT....等等, 按上面的写法, 不同relate_order_id分组取出来的create_date,对应的只是其中的第一条件记录对应的日期 , 在汇总统计运算中,大多没有实际参考意义</p>

<pre><code class="language-sql">SELECT relate_order_id,COUNT(*), MAX(create_date),SUM(price_deposit) FROM `tb_example WHERE create_date &gt;&#39;2020-02-01&#39; GROUP BY relate_order_id
</code></pre>

<p>补充说明: <br/>
mysql中group by默认会执行排序操作, 如果不是必须, 可以添加 order by null取消在数据库端排序, 减少数据库中的运算, 取到结果后在应用中再做排序</p>

<h2 id="toc_15">0x0E 组合索引</h2>

<pre><code class="language-sql">SELECT COUNT(*) AS cnt FROM tb_example WHERE update_date &gt;= &#39;2020-01-19&#39; AND last_city_id =19 AND es_update=0
</code></pre>

<p>针对上面sql, 新建索引参考:  where条件中last_city_id数据的唯一性高于 es_update,  而update_date是范围条件, 按先等值, 再范围条件的顺序建立, 如果都是等值条件, 唯一性高的字段在前, 添加组合索引如下:</p>

<pre><code class="language-sql">ALTER TABLE tb_example ADD INDEX idx_last_city_id (last_city_id, es_update, update_date)
</code></pre>

<p>说明: 索引是最左前缀匹配, 除了上面sql, 以下语句也能用上新建索引,  语句中where条件不包含last_city_id字段, 都无法使用此索引</p>

<pre><code class="language-sql">SELECT COUNT(*) AS cnt FROM tb_example WHERE   last_city_id =19 AND es_update=0
SELECT COUNT(*) AS cnt FROM tb_example WHERE   last_city_id =19 AND update_date &gt;= &#39;2020-01-19&#39;
SELECT COUNT(*) AS cnt FROM tb_example WHERE   last_city_id =19 
</code></pre>

<h2 id="toc_16">0x0F 强制索引</h2>

<p>force index: <br/>
当mysql默认的执行计划选择错误时, 可以通过force index指定过滤性更好的索引提升性能</p>

<p>缺点: 当索引名称修改时, 应用代码中也要同步修改;<br/>
当数据大量删除或跟之前相比有明显变化时,  如果mysql默认执行计划选择正确 , 那么强制索引也要跟着变化或取消</p>

<pre><code class="language-sql">SELECT
    count( 1 ) AS total
FROM
    `tb_example FORCE INDEX ( idx_uid_date )  
WHERE
    uid = 1785334
    AND inverse_date &gt;- 1579366800
    AND inverse_date &lt;- 1579363200 
</code></pre>

<h2 id="toc_17">0x10 Explain性能分析简介</h2>

<p><img src="media/15870941721023/15870966502049.jpg" alt=""/></p>

<ol>
<li>Type<br/>
当type出现ALL时, 表示实际执行时会有全表扫描问题, 需要尽力避免</li>
<li>Key<br/>
表示语句实际用到的索引, 索引效率差时,可以新增或强制索引</li>
<li>Rows<br/>
表示获取结果前需要过滤的行数, 越小越好</li>
<li>key_len<br/>
实际使用索引的字节长度, 通过这个值,可以了解多列组合索引中各字段是否完全使用</li>
</ol>

<h2 id="toc_18">0x11 判断组合索引使用的字段</h2>

<p>例: 表tb_example 有索引idx_pid_edate(pid, type_id, status, end_date)<br/>
索引中各字段数据类型:<br/>
pid           INT   4<br/>
type_id    TINYINT  1<br/>
status      TINYINT  1<br/>
end_date DATE  3</p>

<p>说明: where条件有3个字段, 执行计划显示用到了idx_pid_edate 索引, 但key_len显示为5,  表示实际执行时, 只用到了索引中的前两列 pid, type_id (4+1=5bytes); 如果索引中有varchar型字段, key_len要相应增加1-2bytes, 如果允许为NULL, 增加1bytes</p>

<p><img src="media/15870941721023/15870967042850.jpg" alt=""/></p>

<h2 id="toc_19">0x12 mysq中实现事务的常见方式</h2>

<p>方法1:start transaction; sql语句...;commit;说明: 在sql脚本,存储过程, 客户端工具,应用代码中都能通用, 推荐使用</p>

<p>方法2:begin; sql语句...;commit;限制: 关键字包含begin,  在存储过程中不能使用<br/>
方法3:set autocommit = 0; sql语句...;commit;说明: 借助mysql变量实现事务 , 通常应用框架中会使用aucommit来控制提交或回滚, 使用这种方式, 每执行一条语句就表示隐含开了个事务, 在读写语句执行完后,都要加commit, 另外, 通过日志排查问题不是很方便</p>

<h2 id="toc_20">0x13 select ... for update使用误区</h2>

<p>部分开发同事认为select ... for update语句默认会启用事务加锁,真实情况是, 除非显示地启用事务, 否则这个语句与普通select语句执行没有差异, 无法实现加锁功能; </p>

<p>例:以下事务中的 for update语句, 实现对id=1的记录加意向更新锁,  在事务提交前, 其他会话会无法更新这条记录</p>

<pre><code class="language-sql">start transaction;  
select ... from tb where id = 1 for update;  
update....commit;
</code></pre>

<h2 id="toc_21">0x14 使用事务注意事项</h2>

<p>(1)代码中同一会话多次启用事务<br/>
If条件处理逻辑,导致并发执行时,执行到这部分就return退出,并未执行到后面的commit语句,这种情况会出现一个长时间不提交的大事务,日志中会出现很多不同用户的访问全在同一线程中,<br/>
由于事务长时间不提交也未回滚, 当有并发更新时, 会出现大量锁等待超时报错现象</p>

<p>(2)MySQL中同一会话中多次启用事务</p>

<p>start transaction;  <br/>
  update tb_example set total_amount = 1000  where id = 1;  </p>

<p>再次启用事务时, 会将前面未提交的事务执行自动提交</p>

<p>start transaction; <br/>
  insert into tb_example (uid, ukey, uvalue) VALUES(1, 5,203); <br/>
commit;</p>

<h3 id="toc_22">事务简单总结:</h3>

<p>1.代码中避免<br/>
确保事务短小,代码中做好各类异常判断处理, 及时提交或回滚语句,避免并发时,事务加锁时间过长影响业务正常运行</p>

<p>2.proxy层限制<br/>
通过max_transaction_time(可动态设置),强制中止超时的事务执行</p>

<p>3.数据库限制<br/>
通过innodb_rollback_on_timeout参数(重启实例生效),在实例级回滚所有未提交的异常事务, 适用于代码中事务问题少,回滚影响面较小时启用</p>

<h2 id="toc_23">一些注意的点</h2>

<p>是否遵守上面规则根据项目实际情况进行选择</p>


    

      </div>

      <div class="row">
        <div class="large-6 columns">
        <p class="text-left" style="padding:15px 0px;">
      
          <a href="15880004262195.html" 
          title="Previous Post: python高性能之路:使用C/C++编写扩展">&laquo; python高性能之路:使用C/C++编写扩展</a>
      
        </p>
        </div>
        <div class="large-6 columns">
      <p class="text-right" style="padding:15px 0px;">
      
          <a  href="15860923540802.html" 
          title="Next Post: 13/24 设计模式之装饰器模式 Decorator Pattern">13/24 设计模式之装饰器模式 Decorator Pattern &raquo;</a>
      
      </p>
        </div>
      </div>
      <div class="comments-wrap">
        <div class="share-comments">
          <script src="https://utteranc.es/client.js"
        repo="neatlife/neatlife.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


          

          
        </div>
      </div>
    </div><!-- article-wrap -->
  </div><!-- large 8 -->




 <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">
          <div id="site-info" class="site-info">
            
                <h1>xiaolin's blog</h1>
                <div class="site-des">core tech share blog</div>
                <div class="social">
                  <a target="_blank" class="juejin" href="https://juejin.im/user/5c409f86e51d4551c88027a2/posts" title="Juejin">juejin</a>









<a target="_blank" class="github" target="_blank" href="https://github.com/neatlife" title="GitHub">GitHub</a>

  <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
                
              	 </div>
          	</div>

             

              <div id="site-categories" class="side-item ">
                <div class="side-header">
                  <h2>Categories</h2>
                </div>
                <div class="side-content">

      	<p class="cat-list">
        
            <a href="macios.html"><strong>mac&ios</strong></a>
        
            <a href="lc.html"><strong>leetcode</strong></a>
        
            <a href="security.html"><strong>安全</strong></a>
        
            <a href="business.html"><strong>业务</strong></a>
        
            <a href="source-code.html"><strong>源码分析</strong></a>
        
            <a href="redis.html"><strong>Redis</strong></a>
        
            <a href="apache-nginx.html"><strong>Apache/Nginx</strong></a>
        
            <a href="spring-boot.html"><strong>Spring Boot</strong></a>
        
            <a href="pm.html"><strong>项目管理</strong></a>
        
            <a href="sql.html"><strong>SQL</strong></a>
        
            <a href="job-scheduler.html"><strong>任务调度</strong></a>
        
            <a href="design-pattern.html"><strong>设计模式</strong></a>
        
            <a href="mq.html"><strong>消息队列</strong></a>
        
            <a href="rpc.html"><strong>RPC</strong></a>
        
            <a href="laravel.html"><strong>LARAVEL</strong></a>
        
            <a href="tcp-ip.html"><strong>TCP/IP</strong></a>
        
            <a href="uml.html"><strong>UML</strong></a>
        
            <a href="service-mesh.html"><strong>SERVICE MESH</strong></a>
        
            <a href="ci-cd.html"><strong>CI/CD</strong></a>
        
            <a href="ops.html"><strong>OPS</strong></a>
        
            <a href="linux.html"><strong>LINUX</strong></a>
        
            <a href="system-programming.html"><strong>系统编程</strong></a>
        
            <a href="aws.html"><strong>AWS</strong></a>
        
            <a href="lua.html"><strong>LUA</strong></a>
        
            <a href="git.html"><strong>GIT</strong></a>
        
            <a href="js.html"><strong>js</strong></a>
        
            <a href="java.html"><strong>JAVA</strong></a>
        
            <a href="monitor.html"><strong>监控</strong></a>
        
            <a href="vim.html"><strong>VIM</strong></a>
        
            <a href="php.html"><strong>PHP</strong></a>
        
            <a href="openresty.html"><strong>OpenResty</strong></a>
        
            <a href="swoole.html"><strong>SWOOLE</strong></a>
        
            <a href="ons.html"><strong>消息队列</strong></a>
        
            <a href="gdb.html"><strong>GDB</strong></a>
        
            <a href="specification.html"><strong>规范</strong></a>
        
            <a href="3-minutes.html"><strong>三分钟系列</strong></a>
        
            <a href="1-pic.html"><strong>一图胜千言</strong></a>
        
            <a href="account-system.html"><strong>帐号系统</strong></a>
        
            <a href="interview.html"><strong>面试题</strong></a>
        
            <a href="yii.html"><strong>Yii/Yii2</strong></a>
        
            <a href="python.html"><strong>python</strong></a>
        
            <a href="go.html"><strong>GO</strong></a>
        
            <a href="ml.html"><strong>机器学习</strong></a>
        
            <a href="emacs.html"><strong>emacs</strong></a>
        
            <a href="bi.html"><strong>商业智能</strong></a>
        
            <a href="mac.html"><strong>mac</strong></a>
        
            <a href="editor.html"><strong>编辑器</strong></a>
        
            <a href="productive-soft.html"><strong>生产力工具</strong></a>
        
            <a href="driver-license.html"><strong>驾照</strong></a>
         
        </p>


                </div>
              </div>

              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                <ul class="posts-list">
	      
		      
			      <li class="post">
			        <a href="16081898834624.html">OSX使用代码代替storyboard构建项目，并添加NSSplitView组件</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="16005640944829.html">linux系统编程之多进程和管道（pip）</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15970226751276.html">三分钟上手java多线程控制技术</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15864793262262.html">14/24 设计模式之状态模式 State Pattern</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15880004262195.html">python高性能之路:使用C/C++编写扩展</a>
			      </li>
		     
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		   
		  		</ul>
                </div>
              </div>
        </div><!-- sidebar -->
      </div><!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row -->

 <div class="page-bottom clearfix">
  <div class="row">
   <p class="copyright">Copyright &copy; 2015
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.
<span id="busuanzi_container_site_uv">访问<span id="busuanzi_value_site_uv"></span>人</span>/
        <span id="busuanzi_container_site_pv"><span id="busuanzi_value_site_pv"></span>次</span>
    </p>
  </div>
</div>

        </section>
      </div>
    </div>

  
    

    <script src="asset/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
      function fixSidebarHeight(){
        var w1 = $('.markdown-body').height();
          var w2 = $('#sidebar').height();
          if (w1 > w2) { $('#sidebar').height(w1); };
      }
      $(function(){
        fixSidebarHeight();
      })
      $(window).load(function(){
          fixSidebarHeight();
      });
     
    </script>

    

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-138141150-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-138141150-1');
</script>

<canvas class="fireworks" 
        style="position: fixed; left: 0px; top: 0px; z-index: 99999999; pointer-events: none; width: 1158px; height: 916px;" 
        width="2316" 
        height="1832">
</canvas>
    <script src="asset/js/anime.min.js"></script>
    <script src="asset/js/fireworks.js"></script>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  </body>
</html>
